<!DOCTYPE html>
<html>
<head>
  <title>MovieHub Seat Realtime Test</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    input { padding: 8px; margin: 5px; }
    button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
    #log { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; background: #f9f9f9; margin-top: 20px; }
    p { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>üé¨ MovieHub Seat Realtime Test</h1>
  
  <div>
    <input id="token" placeholder="JWT Token" value="test-token" style="width: 300px;" />
    <input id="showtimeId" placeholder="Showtime ID" value="showtime-123" />
    <button onclick="connect()">‚úÖ Connect</button>
  </div>
  
  <hr>
  
  <div>
    <h3>Hold/Release Seats</h3>
    <input id="seatId" placeholder="Seat ID" value="seat-A1" />
    <button onclick="holdSeat()">üéØ Hold Seat</button>
    <button onclick="releaseSeat()">üîì Release Seat</button>
  </div>

  <div>
    <h3>Test Scenarios</h3>
    <button onclick="testHoldMultiple()">üî¢ Hold 8 Seats (Limit Test)</button>
    <button onclick="testHold9th()">‚ö†Ô∏è Try Hold 9th (Should Fail)</button>
  </div>
  
  <div id="log"></div>
  
  <script>
    let socket;
    
    function log(msg) {
      const div = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      div.innerHTML += `<p><strong>${time}:</strong> ${msg}</p>`;
      div.scrollTop = div.scrollHeight;
    }
    
    function connect() {
      const token = document.getElementById('token').value;
      const showtimeId = document.getElementById('showtimeId').value;
      
      if (!token || !showtimeId) {
        log('‚ùå Please fill in token and showtimeId');
        return;
      }
      
      socket = io('ws://localhost:4000', {
        auth: { token },
        query: { showtimeId }
      });
      
      socket.on('connect', () => {
        log('‚úÖ Connected to WebSocket');
      });
      
      socket.on('seat_held', (data) => {
        log(`üéØ Seat held: ${JSON.stringify(data)}`);
      });
      
      socket.on('seat_released', (data) => {
        log(`üîì Seat released: ${JSON.stringify(data)}`);
      });
      
      socket.on('seat_expired', (data) => {
        log(`‚è∞ Seats expired: ${JSON.stringify(data)}`);
      });
      
      socket.on('limit_reached', (data) => {
        log(`üö´ LIMIT REACHED: ${JSON.stringify(data)}`);
      });
      
      socket.on('seat_booked', (data) => {
        log(`üí≥ Seat booked: ${JSON.stringify(data)}`);
      });
      
      socket.on('connect_error', (error) => {
        log(`‚ùå Connection error: ${error.message}`);
      });
      
      socket.on('disconnect', (reason) => {
        log(`üîå Disconnected: ${reason}`);
      });
    }
    
    function holdSeat() {
      const showtimeId = document.getElementById('showtimeId').value;
      const seatId = document.getElementById('seatId').value;
      
      if (!socket) {
        log('‚ùå Not connected. Click Connect first.');
        return;
      }
      
      socket.emit('hold_seat', { showtimeId, seatId });
      log(`üì§ Emitted: hold_seat(${seatId})`);
    }
    
    function releaseSeat() {
      const showtimeId = document.getElementById('showtimeId').value;
      const seatId = document.getElementById('seatId').value;
      
      if (!socket) {
        log('‚ùå Not connected. Click Connect first.');
        return;
      }
      
      socket.emit('release_seat', { showtimeId, seatId });
      log(`üì§ Emitted: release_seat(${seatId})`);
    }
    
    function testHoldMultiple() {
      const showtimeId = document.getElementById('showtimeId').value;
      
      if (!socket) {
        log('‚ùå Not connected.');
        return;
      }
      
      log('üî¢ Holding 8 seats...');
      for (let i = 1; i <= 8; i++) {
        setTimeout(() => {
          socket.emit('hold_seat', { showtimeId, seatId: `seat-A${i}` });
        }, i * 200);
      }
    }
    
    function testHold9th() {
      const showtimeId = document.getElementById('showtimeId').value;
      
      if (!socket) {
        log('‚ùå Not connected.');
        return;
      }
      
      log('‚ö†Ô∏è Trying to hold 9th seat (should trigger limit_reached)...');
      socket.emit('hold_seat', { showtimeId, seatId: 'seat-A9' });
    }
  </script>
</body>
</html>