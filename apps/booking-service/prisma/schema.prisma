// This is your Prisma schema file for Booking Service
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================
// Enums
// ======================
enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  EXPIRED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  MOMO
  ZALOPAY
  VNPAY
  BANK_TRANSFER
  CASH
}

enum TicketStatus {
  VALID
  USED
  CANCELLED
  EXPIRED
}

enum RefundStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ConcessionCategory {
  FOOD
  DRINK
  COMBO
  MERCHANDISE
}

enum PromotionType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_ITEM
  POINTS
}

enum LoyaltyTransactionType {
  EARN
  REDEEM
  EXPIRE
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

// ======================
// Models
// ======================

model Bookings {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  booking_code        String        @unique @db.VarChar(20)
  user_id             String        @db.VarChar(255)
  showtime_id         String        @db.Uuid
  customer_name       String        @db.VarChar(255)
  customer_email      String        @db.VarChar(255)
  customer_phone      String?       @db.VarChar(20)
  subtotal            Decimal       @db.Decimal(10, 2)
  discount            Decimal       @default(0) @db.Decimal(10, 2)
  points_used         Int           @default(0)
  points_discount     Decimal       @default(0) @db.Decimal(10, 2)
  final_amount        Decimal       @db.Decimal(10, 2)
  promotion_code      String?       @db.VarChar(50)
  status              BookingStatus @default(PENDING)
  payment_status      PaymentStatus @default(PENDING)
  expires_at          DateTime?     @db.Timestamp(6)
  cancelled_at        DateTime?     @db.Timestamp(6)
  cancellation_reason String?       @db.Text
  created_at          DateTime      @default(now()) @db.Timestamp(6)
  updated_at          DateTime      @default(now()) @db.Timestamp(6)

  tickets           Tickets[]
  payments          Payments[]
  booking_concessions BookingConcessions[]
  @@index([user_id])
  @@index([showtime_id])
  @@index([status])
}

model Tickets {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  booking_id  String       @db.Uuid
  seat_id     String       @db.Uuid
  ticket_code String       @unique @db.VarChar(50)
  qr_code     String?      @db.Text
  barcode     String?      @db.VarChar(100)
  ticket_type String       @db.VarChar(50)
  price       Decimal      @db.Decimal(10, 2)
  status      TicketStatus @default(VALID)
  used_at     DateTime?    @db.Timestamp(6)
  created_at  DateTime     @default(now()) @db.Timestamp(6)

  booking Bookings @relation(fields: [booking_id], references: [id], onDelete: Cascade)

  @@index([booking_id])
  @@index([seat_id])
}

model Payments {
  id                      String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  booking_id              String        @db.Uuid
  amount                  Decimal       @db.Decimal(10, 2)
  payment_method          PaymentMethod
  status                  PaymentStatus @default(PENDING)
  transaction_id          String?       @unique @db.VarChar(255)
  provider_transaction_id String?       @db.VarChar(255)
  payment_url             String?       @db.Text
  paid_at                 DateTime?     @db.Timestamp(6)
  metadata                Json?
  created_at              DateTime      @default(now()) @db.Timestamp(6)
  updated_at              DateTime      @default(now()) @db.Timestamp(6)

  booking Bookings  @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  refunds Refunds[]

  @@index([booking_id])
  @@index([status])
}

model Refunds {
  id         String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  payment_id String       @db.Uuid
  amount     Decimal      @db.Decimal(10, 2)
  reason     String       @db.Text
  status     RefundStatus @default(PENDING)
  refunded_at DateTime?   @db.Timestamp(6)
  created_at DateTime     @default(now()) @db.Timestamp(6)

  payment Payments @relation(fields: [payment_id], references: [id], onDelete: Cascade)

  @@index([payment_id])
}

model Concessions {
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String              @db.VarChar(255)
  name_en        String?             @db.VarChar(255)
  description    String?             @db.Text
  category       ConcessionCategory
  price          Decimal             @db.Decimal(10, 2)
  image_url      String?             @db.VarChar(500)
  available      Boolean             @default(true)
  inventory      Int?
  cinema_id      String?             @db.Uuid
  nutrition_info Json?
  allergens      String[]            @db.Text
  created_at     DateTime            @default(now()) @db.Timestamp(6)
  updated_at     DateTime            @default(now()) @db.Timestamp(6)

  booking_concessions BookingConcessions[]

  @@index([category])
  @@index([available])
}

model BookingConcessions {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  booking_id    String   @db.Uuid
  concession_id String   @db.Uuid
  quantity      Int
  unit_price    Decimal  @db.Decimal(10, 2)
  total_price   Decimal  @db.Decimal(10, 2)
  created_at    DateTime @default(now()) @db.Timestamp(6)

  booking    Bookings    @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  concession Concessions @relation(fields: [concession_id], references: [id], onDelete: Cascade)

  @@index([booking_id])
  @@index([concession_id])
}

model Promotions {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code            String        @unique @db.VarChar(50)
  name            String        @db.VarChar(255)
  description     String?       @db.Text
  type            PromotionType
  value           Decimal       @db.Decimal(10, 2)
  min_purchase    Decimal?      @db.Decimal(10, 2)
  max_discount    Decimal?      @db.Decimal(10, 2)
  valid_from      DateTime      @db.Timestamp(6)
  valid_to        DateTime      @db.Timestamp(6)
  usage_limit     Int?
  usage_per_user  Int?          @default(1)
  current_usage   Int           @default(0)
  applicable_for  String[]      @db.Text
  conditions      Json?
  active          Boolean       @default(true)
  created_at      DateTime      @default(now()) @db.Timestamp(6)
  updated_at      DateTime      @default(now()) @db.Timestamp(6)

  @@index([code])
  @@index([active])
}

model LoyaltyAccounts {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String       @unique @db.VarChar(255)
  current_points Int         @default(0)
  tier          LoyaltyTier  @default(BRONZE)
  total_spent   Decimal      @default(0) @db.Decimal(12, 2)
  created_at    DateTime     @default(now()) @db.Timestamp(6)
  updated_at    DateTime     @default(now()) @db.Timestamp(6)

  transactions LoyaltyTransactions[]

  @@index([user_id])
}

model LoyaltyTransactions {
  id              String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  loyalty_account_id String              @db.Uuid
  points          Int
  type            LoyaltyTransactionType
  transaction_id  String?                @db.Uuid
  description     String?                @db.Text
  expires_at      DateTime?              @db.Timestamp(6)
  created_at      DateTime               @default(now()) @db.Timestamp(6)

  loyalty_account LoyaltyAccounts @relation(fields: [loyalty_account_id], references: [id], onDelete: Cascade)

  @@index([loyalty_account_id])
  @@index([type])
}
